<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sakura.meetu.mapper.DynamicMapper">

    <!-- TODO (sakura, 2023/9/9, 15:06, 差 评论数量) -->
    <select id="selectALLBYUserIdOrDynamicId" resultType="com.sakura.meetu.vo.DynamicVo">
        SELECT
            d.id, d.user_id, d.name,
            d.content, d.time, d.view,
            d.descr, d.img,
            COUNT(p.fid) AS praise_count,
            COUNT(c.dynamic_id) AS collect_count,
            COUNT(cm.dynamic_id) AS comment_count
        FROM
            dynamic d
        LEFT JOIN
            praise p ON d.id = p.fid AND p.deleted = 0
        LEFT JOIN
            collect c ON d.id = c.dynamic_id AND c.deleted = 0
        LEFT JOIN
            comments cm ON d.id = cm.dynamic_id AND cm.deleted = 0
        <where>
            <if test="dynamicId != null">
                AND d.id = #{dynamicId}
            </if>
            <if test="userId != null">
                AND d.user_id = #{userId}
            </if>
            <if test="dynamicName != null">
                AND d.name LIKE #{dynamicName} '%'
            </if>
            AND d.deleted = 0
        </where>
        GROUP BY
            d.id
    </select>
</mapper>
